<div class="form-page-container" *ngIf="tenant$ | async as tenant">
    <div class="back-nav" (click)="cancel()">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"
            class="back-icon">
            <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
        </svg>
        <span>Back to Tenants</span>
    </div>

    <h2 class="page-title">Tenant Details</h2>

    <div class="add-tenant-card">

        <div class="card-header">
            <button type="button" class="icon-btn" (click)="toggleMode()"
                [title]="mode === 'view' ? 'Edit Tenant' : 'View Mode'">

                <img *ngIf="mode === 'view'" src="assets/icons/edit-tenant.svg" alt="Edit Tenant" />

                <img *ngIf="mode === 'edit'" src="assets/icons/view-tenant.svg" alt="View Tenant" />
            </button>

            <div class="header-actions" *ngIf="mode === 'view' && tenant.status ==='Active'">

                <!-- Change Room -->
                <button type="button" class="icon-btn change-room-btn" title="Change Room" (click)="openChangeRoom()">
                    <img src="assets/icons/change-room.svg" alt="Change Room" />
                </button>

                <!-- Move Out -->
                <button type="button" class="icon-btn move-out-btn" title="Move Out Tenant" (click)="confirmMoveOut()">
                    <img src="assets/icons/move-out.svg" alt="Move Out" />
                </button>

            </div>
        </div>

        <div class="form-grid">

            <!-- ================= LEFT SECTION ================= -->
            <div class="form-section section-left">
                <h3 class="section-subtitle">Tenant Details</h3>

                <div class="form-group">
                    <label>Tenant Name</label>
                    <div class="form-input readonly" *ngIf="mode === 'view'">
                        {{ tenant.name }}
                    </div>
                    <input *ngIf="mode === 'edit'" type="text" class="form-input" [(ngModel)]="editableTenant.name" />
                </div>

                <div class="form-group">
                    <label>Mobile Number</label>
                    <div class="form-input readonly" *ngIf="mode === 'view'">
                        {{ tenant.contactNumber }}
                    </div>
                    <input *ngIf="mode === 'edit'" type="text" class="form-input"
                        [(ngModel)]="editableTenant.contactNumber" />
                </div>

                <div class="form-group">
                    <label>Aadhaar Number</label>
                    <div class="form-input readonly" *ngIf="mode === 'view'">
                        {{ tenant.aadharNumber }}
                    </div>
                    <input *ngIf="mode === 'edit'" type="text" class="form-input"
                        [(ngModel)]="editableTenant.aadharNumber" />
                </div>
            </div>

            <!-- ================= RIGHT SECTION ================= -->
            <div class="form-section section-right">
                <h3 class="section-subtitle">Room Details</h3>

                <div class="form-group">
                    <label>Status</label>
                    <div class="form-input readonly">
                        {{ tenant.status }}
                    </div>
                </div>

                <div class="form-group">
                    <label>Room</label>
                    <div class="form-input readonly">
                        {{ tenant.roomNumber ?? '—' }}
                    </div>
                </div>

                <div class="form-group">
                    <label>Checked In Date</label>
                    <div class="form-input readonly">
                        {{ tenant.checkedInAt | date }}
                    </div>
                </div>
            </div>

            <!-- ================= BOTTOM SECTION ================= -->
            <div class="form-section section-bottom">
                <h3 class="section-subtitle">Financial Details</h3>

                <div class="financial-row">
                    <div class="form-group">
                        <label>Advance Amount (₹)</label>
                        <div class="form-input readonly">
                            ₹ {{ tenant.advanceAmount }}
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Rent Paid Upto</label>
                        <div class="form-input readonly">
                            {{ tenant.rentPaidUpto | date }}
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Notes</label>
                    <div class="form-input readonly notes" *ngIf="mode === 'view'">
                        {{ tenant.notes }}
                    </div>
                    <textarea *ngIf="mode === 'edit'" rows="3" class="form-input" [(ngModel)]="editableTenant.notes">
  </textarea>
                </div>
            </div>

        </div>

        <!-- ================= ACTIONS ================= -->
        <div class="actions" *ngIf="mode === 'edit'">
            <button type="button" class="btn-cancel" (click)="cancel()">
                Cancel
            </button>

            <button type="button" class="btn-save" (click)="save()">
                Save
            </button>
        </div>


    </div>
    <div class="pending-rent-card" *ngIf="pendingRent$ | async as pending">

        <div class="pending-header-row">
            <div class="pending-left">
                <div class="pending-title-block">
                    <h3>Pending Rent</h3>
                    <p class="as-of">
                        As of {{ pending.asOfDate | date:'dd MMM yyyy' }}
                    </p>
                </div>
                <div class="pending-amount-display">
                    ₹{{ pending.totalPendingAmount | number:'1.2-2' }}
                </div>
            </div>

            <button class="btn-add-payment-pill" [disabled]="pending.totalPendingAmount === 0" (click)="addPayment()">
                Add Payment
            </button>
        </div>


        <hr class="pending-divider" />

        <div class="pending-breakdown" *ngIf="pending.breakdown.length > 0">
            <h4 class="breakdown-label">Breakdown</h4>

            <table class="pending-table">
                <thead>
                    <tr>
                        <th class="text-left">Room</th>
                        <th class="text-left">Period</th>
                        <th class="text-right">Rate / Day</th>
                        <th class="text-right">Amount</th>
                    </tr>
                </thead>

                <tbody>
                    <tr *ngFor="let b of pending.breakdown">
                        <td class="text-left">{{ b.roomNumber }}</td>
                        <td class="text-left period-cell">
                            {{ b.fromDate | date:'dd MMM' }}
                            <span class="arrow">→</span>
                            {{ b.toDate | date:'dd MMM yyyy' }}
                        </td>
                        <td class="text-right">₹{{ b.rentPerDay | number:'1.2-2' }}</td>
                        <td class="text-right amount-cell">₹{{ b.amount | number:'1.2-2' }}</td>
                    </tr>
                </tbody>

                <tfoot>
                    <tr>
                        <td colspan="3" class="total-label text-left">Total Outstanding</td>
                        <td class="text-right total-amount" [ngClass]="{
    'amount-clear': pending.totalPendingAmount === 0,
    'amount-due': pending.totalPendingAmount > 0
  }">
                            ₹{{ pending.totalPendingAmount | number:'1.2-2' }}
                        </td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
    <!-- ================= CHANGE ROOM MODAL ================= -->
    <div class="modal-backdrop" *ngIf="isChangeRoomOpen"></div>

    <div class="modal" *ngIf="isChangeRoomOpen">
        <div class="modal-header">
            <h3 class="modal-title">Change Room</h3>

            <button type="button" class="icon-btn modal-close" (click)="closeChangeRoom()">
                ✕
            </button>
        </div>

        <div class="modal-body">

            <div class="floating-select">

                <select class="form-input" [(ngModel)]="selectedRoomId">
                    <option value="" disabled hidden></option>

                    <option *ngFor="let room of rooms$ | async" [value]="room.roomId">
                        Room {{ room.roomNumber }} ({{ room.vacancies }} beds available)
                    </option>
                </select>

                <label class="floating-label" [class.filled]="!!selectedRoomId">
                    Select New Room
                </label>

            </div>

        </div>

        <div class="modal-actions">
            <button class="btn-cancel" (click)="closeChangeRoom()">
                Cancel
            </button>

            <button class="btn-save" [disabled]="!selectedRoomId || isChangingRoom" (click)="confirmChangeRoom()">
                Change Room
            </button>
        </div>
    </div>

</div>